---
title: "HAB model"
date: '2024-04-02'
output:
  html_document: default
  pdf_document: 
    latex_engine: xelatex
    keep_tex: true
    includes:
      in_header: preamble.tex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE)
```

<!--- For HTML Only --- Equivalent code for .pdf must be included in preamble.tex -->
`r if (!knitr:::is_latex_output()) '
$\\DeclareMathOperator*{\\argmin}{argmin}$
$\\DeclareMathOperator*{\\logit}{logit}$
$\\newcommand{\\var}{\\mathrm{Var}}$
$\\newcommand{\\bfa}[2]{{\\rm\\bf #1}[#2]}$
$\\newcommand{\\rma}[2]{{\\rm     #1}[#2]}$'`

```{r error=FALSE, warning=FALSE, message=FALSE}
# Packages + set up
load("opar.Rda")
library(readxl)
library(dplyr)
library(tidyverse)
library(tidyr)
library(readxl)
library(ggplot2)
library(maps)
library(sf)
library(geojsonsf)
library(rmapshaper)
library(magick)
library(colorspace)
library(kableExtra)

library(algae)
source("funcs.R")
source("maps.R")
source("setup.R")
```

## Model

 * $n$ polygons $i=1,\ldots,n$
 * $t$ time in weeks: Week 0 is the week of 1 January 2018, $t=0,\ldots,T$
 * $q_t$ is the seasonal indicator: 1 if the week is in the months of December-July, 0 otherwise
 * $V_i$ polygon volume to a depth of 15m
 * $A_i$ polygon area
 * $P_{ijt}$ = proportion of mass in polygon $j$ moving to polygon $i$ in week $t$. 
 * Retention: $W_{jt} \equiv \sum_{i=1}^n P_{ijt}$ proportion of mass in polygon $j$ 
   retained by the system (i.e. not lost at the edges) over the one week period at time $t$
 * Mass conservation implies
   \[ 
     W_{jt} = \sum_{i=1}^n P_{ijt}\leq 1 \qquad\text{for all $j,t$}
   \]
   If the sum is less than 1 when mass is lost at the edges of the set of polygons.
 * Residency: $R_{it} \equiv P_{iit}$ = proportion of mass remaining resident in polygon $i$ in week $t$
 * ${\bf x}_{it}$ covariates in polygon $i$ at time $t$ (temperature, salinity, etc.), excluding residency
   where the sum is less than 1 when mass is lost at the edges of the set of
   polygons.
 * Retention: $W_{jt} \equiv \sum_{i=1}^n P_{ijt}$ proportion of mass in polygon $j$ 
   retained by the system (i.e. not lost at the edges) over the one week period at time $t$
 * $R_{it} \equiv P_{iit}$ = proportion of mass remaining resident in polygon $i$ in week $t$
 * ${\bf x}_{it}$ covariates in polygon $i$ at time $t$ (temperature, salinity, etc.)
 
 * Polygon carrying capacity
   \[
      M_{cit} = V_i e^{\alpha_c + {\bf x}_{it}^T\beta_c + \lambda_c\log R_{it}}
   \]

 * At time step $t$ the epoch indicator $E_t|E_{t-1}$ is drawn
   \begin{eqnarray*}
      E_0           &\sim& \text{Bernoulli}(\mbox{$\frac12$})\\
      E_t|E_{t-1}=0 &\sim& \text{Bernoulli}(\tau_0 q_t)\qquad\text{for $t>0$}\\
      E_t|E_{t-1}=1 &\sim& \text{Bernoulli}(\tau_1 q_t)
   \end{eqnarray*}
   where $\tau_0$ is the probability of initiation of an epoch favourable to algal blooms 
   ($\tau_0$ is low), and $\tau_1$ is the probability of the persistence of that epoch.
 * Growth rate in polygon $i$ at time $t$
   \[
      Q_{it} = e^{ -\gamma_2(1-E_t) 
                          + E_t(\alpha_2 + {\bf x}_{it}^T{\beta}_2 + \lambda_2\log R_{it}) 
      }
   \]
   $\alpha_2>0$ is the basic (covariate independent) growth rate of blooms in a favourable epoch $E_t=1$,
   and $\lambda_2>0$.  
   
   $\gamma_2>0$ is the decay rate of blooms in an unfavourable epoch $E_t=0$.
 * Carrying capacity of polygon $i$ at time $t$
   \[
      M_{cit} = V_i \rho_c R_{it}^{\lambda_c} = V_i e^{\alpha_c + {\bf x}_{it}^T\beta_c + \lambda_c \log R_{it}}
   \]
   Note that a polygon with zero residency cannot retain mass in this model and has $M_{cit}=0$.
   \[
      Q_{it} = e^{ -\gamma(1-E_t) 
                          + E_t(\alpha + {\bf x}_{it}^T{\beta}_2 + \lambda_2\log R_{it}) 
      }
   \]
   If $E_t=1$ we have growth ($\alpha>0$, $\lambda_2>0$) and if $E_t=0$ we have
   decay ($\gamma>0$).

 * $\pi_{it}$ bloom initiation probability in polygon $i$ at time $t$
   \[
      \log\pi_{it} = \log A_i + \alpha_0 + {\bf x}_{it}^T{\beta}_0 + \lambda_0 \log R_{it}
   \]
   Note that $\pi_{it}<<1$
 * At time step $t$ in each polygon $i$ the innovation indicator is drawn
   \[
      I_{it}|E_t \sim \text{Bernoulli}(\pi_{it}E_t)
   \]
   An innovation in biomass only occurs in a polygon if $t$ is in a favourable epoch ($E_t\neq 0$).
 * New biomass innovation in polygon $i$ at time $t$
   \begin{eqnarray*}
      B_{it} | I_{it}=0 &\sim& \delta_0\\
      B_{it} | I_{it}=1 &\sim& \text{Gamma}(a,b)
   \end{eqnarray*}
   $\delta_0$ is a point mass at zero: we get no new biomass if $I_{it}=0$.
 * Baseline algal mass distribution $M_{i0}=0$ for all $i$: i.e. no mass at time $t=0$.
 * Time evolution of algal mass $M_{it}$ for $t>0$
   \begin{eqnarray*}
      D_{it} &=& B_{it} + \sum_{j=1}^n P_{ijt} e^{E_t({\bf x}_{jt}^T{\beta}_1 + \lambda_1 \log R_{jt})} M_{j,t-1}\\
      M_{it} &=& e^{\eta_{it}} M_{cit} \left[1 - e^{-Q_{it}D_{it}/M_{cit}}\right]
   \end{eqnarray*}
 * Time evolution of algal mass $M_{it}$ for $t>0$: first compute the transported/innovation
   biomass
   \[
      M_{dit} = B_{it} + \sum_{j=1}^n P_{ijt} 
                                     e^{E_t({\bf x}_{jt}^T{\beta}_1 + \lambda_1 \logit R_{jt})}
                                     M_{j,t-1}
   \]
 * Then
   \[
      M_{it} = e^{\eta_{it}} M_{dit}\left[ Q_{it} + (1-Q_{it})\frac{M_{dit}}{M_{cit}} \right]
   \]
   where
   \[
      \eta_{it} \sim \text{Normal}(0,\sigma^2_\eta)
   \]
   We may not need both of $({\lambda_1,\beta}_1)$ (growth before transport) in addition to 
   $(\lambda_2,{\beta}_2)$ (growth after transport, within $Q_{it}$).
 * Observation of algal density $Y_{it}$
   \begin{eqnarray*}
     Y_{it} | M_{it} = 0 &\sim& \delta_0\\
     \log Y_{it} | M_{it}>0, \sigma_\varepsilon^2 &\sim& \text{Normal}(\log (M_{it}/V_i),
     \sigma_\varepsilon^2)
   \end{eqnarray*}


Summary of quantities

Indexing

* $i=1,\ldots,n$ - labels of polygons
* $t=0,\ldots,T$ - labels of weeks

Fixed

* $q_t$ seasonal indicator (1 if the week is in the months of December-July, 0 otherwise)
* $V_i$ volume of polygon $i$ to a depth of 15m
* $A_i$ area of polygon $i$

Observed/Modelled separately

* ${\bf x}_{it}$ - covariates (temperature, salinity, etc)
* $P_{ijt}$ - proportion of mass in polygon $j$ moving to polygon $i$ in week $t$
* $Y_{it}$ - observed density (in a subset of polygons at a subset of times)

Latent (to be estimated)

* $E_t$ epoch indicator
* $I_{it}$ innovation indicator
* $B_{it}$ innovation biomass
* $M_{it}$ mass in polygon $i$ at time $t$

Derived

* $R_{it}$ - residency: derived from ${\bf P}_t$: $R_{it} = P_{iit}$
* $\pi_{it}$ - bloom initiation probability: $\log\pi_{it}=\log A_i + \alpha_0 + {\bf x}_{it}^T{\beta}_0+\lambda_0\log R_{it}$

Parameters (to be estimated)

* $\tau_0$ growth epoch initiation probability
* $\tau_1$ growth epoch persistence probability
* $(\gamma_2, \alpha_2)$ baseline log growth parameters in epochs 0 (decay) and 1 (growth)
* $(\alpha_c,\lambda_c,\beta_c)$ parameters of carrying capacity
* $(\alpha_0,\lambda_0,\beta_0)$ parameters of bloom initiation probability
* $(\lambda_1,\beta_1)$ parameters of pre-transport growth
* $(\lambda_2,\beta_2)$ parameters of post-transport growth
* $\sigma_\eta$ - mass evolution error
* $\sigma_\varepsilon$ - density observation error

## Simplest model

 * Carrying capacity of polygon $i$ at time $t$
   \[
      M_{cit} = V_i \rho_c R_{it}^{\lambda_c} = V_i e^{\alpha_c + \lambda_c \log R_{it}}
   \]
 * $\pi_{it}$ bloom initiation probability in polygon $i$ at time $t$
   \[
      \log\pi_{it}  = \log A_i + \alpha_0 + \lambda_0 \log R_{it}
   \]
 * Epoch
   \begin{eqnarray*}
      E_0           &\sim& \text{Bernoulli}(\mbox{$\frac12$})\\
      E_t|E_{t-1}=0 &\sim& \text{Bernoulli}(\tau_0 q_t)\qquad\text{for $t>0$}\\
      E_t|E_{t-1}=1 &\sim& \text{Bernoulli}(\tau_1 q_t)
   \end{eqnarray*}
 * At time step $t$ in each polygon $i$ the innovation indicator is drawn
   \[
      I_{it}|E_t \sim \text{Bernoulli}(\pi_{it}E_t)
   \]
   An innovation in biomass only occurs in a polygon if $t$ is in a favourable epoch ($E_t\neq 0$).
 * New biomass innovation in polygon $i$ at time $t$
   \begin{eqnarray*}
      B_{it} | I_{it}=0 &\sim& \delta_0\\
      B_{it} | I_{it}=1 &\sim& \text{Gamma}(a,b)
   \end{eqnarray*}
 * Baseline algal mass distribution $M_{i0}=0$ for all $i$: i.e. no mass at time $t=0$.
 * Time evolution of algal mass $M_{it}$ for $t>0$
   \begin{eqnarray*}
      D_{it} &=& B_{it} + \sum_{j=1}^n P_{ijt} M_{j,t-1}\\
      M_{it} &=& e^{\eta_{it}} M_{cit} \left[1 - e^{-Q_{it}D_{it}/M_{cit}}\right]
   \end{eqnarray*}
   where
   \[
      \eta_{it} \sim \text{Normal}(0,\sigma^2_\eta)
   \]
   We may not need both of $({\lambda_1,\beta}_1)$ (growth before transport) in addition to 
   $(\lambda_2,{\beta}_2)$ (growth after transport, within $Q_{it}$).
 * Observation of algal density $Y_{it}$
   \begin{eqnarray*}
     Y_{it} | M_{it} = 0 &\sim& \delta_0\\
     \log Y_{it} | M_{it}>0, \sigma_\varepsilon^2 &\sim& \text{Normal}(\log (M_{it}/V_i),
     \sigma_\varepsilon^2)
   \end{eqnarray*}


## Data in the Nydia area

```{r, warning=FALSE}
nydia_sf <- st_crop(marlpoly_sf.trim, 
                    xmin=xlim.nydia[1], xmax=xlim.nydia[2], ymin=ylim.nydia[1], ymax=ylim.nydia[2])
nydia_sf <- nydia_sf %>% filter(!(CLUSTER_ID%in%c(48,71,162,194,251,258,293,406)))
nydia.poly <- nydia_sf$CLUSTER_ID

idx <- nydia.poly
wvec <- date.as.week(matdates)
connsub <- lapply(conn, function(cmat) cmat[idx,][,idx])
ressub <- sapply(connsub,diag)
covsublist <- lapply(covlist, function(cmat) cmat[idx,])
eventsub <- event[event$CLUSTER_ID%in%idx,]
#nrow(eventsub) # 541
#length(unique(eventsub$week)) # 274
#length(unique(eventsub$CLUSTER_ID)) # 11 monitored polygons
#unique(eventsub$CLUSTER_ID)

eventsubw <- eventsub[eventsub$week%in%wvec,]
#nrow(eventsubw) # 12
#length(unique(eventsubw$week)) # 12
#length(unique(eventsubw$CLUSTER_ID)) # 1 # just one polygon: 400

pmat <- t(connsub[[1]])
#dim(pmat) # 17 17
n <- nrow(pmat) # 17 polygons
nydia_sf$nid <- 1:n
#hist(apply(conn[[1]],2,sum))
resvec <- diag(pmat)
```

```{r warning=FALSE}
plot(nydia_sf %>% st_geometry())
text(nydia_sf %>% st_centroid(of_largest_polygon=TRUE) %>% st_coordinates(), 
     lab=as.character(nydia_sf$CLUSTER_ID), cex=0.5)
plot(nydia_sf['volume_15'], main="Volume to 15m (cubic km)")
plot((nydia_sf %>% mutate(residency=resvec[nid]))['residency'], main="1 week water residency")
```


```{r}
hist(apply(pmat,1,sum), xlab=expression(W[j]=="Retention "*Sigma[i]*P[ij]),
     main="Retention", breaks=11)
```

## Data on events

```{r}
# Events
# ensure each event has a preceding event, or insert one which has an NA value
plot(NA,NA,xlim=range(eventsub$week),ylim=range(log(1+eventsub$Value)),xlab="Week",ylab="log(1+Value)",
     main="Concentration (log scale)")
invisible(by(eventsub, eventsub$CLUSTER_ID, 
             function(emat) {
                 extra <- (emat$week-1)[!((emat$week-1) %in% emat$week)]
                 extra <- extra[extra>=min(emat$week)]
                 if(length(extra)>0) {
                   emat <- rbind(emat[,c("week","Value")],data.frame(week=extra,Value=NA))
                 } 
                 emat <- emat[order(emat$week),]
                 #print(emat[,c("week","Value")])
                 lines(emat$week,log(1+emat$Value))
             }))
abline(v=wvec[c(1,length(wvec))],col="red")
```

Note that concentration growth is sharp, but then becomes approximately constant.  This is
what motivates the model structure where we have a polygon carrying capacity.  

### Covariates

Residency: we have matrices $P_{ijt}$ for the weeks 2518-2529 (dates `r week.as.date(2518)`-`r week.as.date(2529)`)

```{r}
# Residency
plot(NA,NA,xlim=range(wvec),ylim=c(0,1),xlab="Week",ylab="Residency",main="Residency over time")
invisible(apply(ressub, 1, function(resvec) lines(wvec,resvec)))
axis(4, at=ressub[,ncol(ressub)], lab=nydia.poly, las=2, cex.axis=0.6)
```
Residency is approximately constant during the periods Week 2518-2529.

```{r}
# Events
plot(NA,NA,xlim=range(wvec),ylim=range(log(1+event$Value)),xlab="Week",ylab="log(1+Value)",
     main="Concentration (log scale)")
invisible(by(eventsub, eventsub$CLUSTER_ID, function(emat) lines(emat$week,log(1+emat$Value))))
```
Concentration rapidly rises, but is then roughly constant.

```{r}
# Temperature
covname <- "Temperature"
xmat <- covsublist[[covname]]
plot(NA,NA,xlim=range(wvec),ylim=range(xmat),xlab="Week",ylab=covname,main=paste(covname,"over time"))
invisible(apply(xmat, 1, function(xvec) lines(wvec,xvec)))
axis(4, at=xmat[,ncol(xmat)], lab=nydia.poly, las=2, cex.axis=0.6)

# Salinity
covname <- "Salinity"
xmat <- covsublist[[covname]]
plot(NA,NA,xlim=range(wvec),ylim=range(xmat),xlab="Week",ylab=covname,main=paste(covname,"over time"))
invisible(apply(xmat, 1, function(xvec) lines(wvec,xvec)))
axis(4, at=xmat[,ncol(xmat)], lab=nydia.poly, las=2, cex.axis=0.6)
```

Temperature over time

```{r}
plot(NA,NA,
     xlim=range(tempdata$date),
     ylim=range(tempdata$tmin,na.rm=TRUE),
     axes=FALSE,xlab="Date",ylab="Daily minimum temperature")
axis.Date(1); axis(2); box()
invisible(by(tempdata,tempdata$Station,function(tt) lines(tt$date,tt$tmin)))
```

```{r}
plot(NA,NA,
     xlim=range(event$date),
     ylim=range(tempdata$tmin,na.rm=TRUE),
     axes=FALSE,xlab="Date",ylab="Daily minimum temperature")
axis.Date(1); axis(2); box()
invisible(by(tempdata,tempdata$Station,function(tt) lines(tt$date,tt$tmin)))
```

## Model implementation

### Nydia

Nydia polygons

```{r warning=FALSE}
#par(mfrow=c(1,2))
plot((nydia_sf %>% st_geometry()), main="Nydia Polygons")
text(nydia_sf %>% st_centroid(of_largest_polygon=TRUE) %>% st_coordinates(), 
     lab=as.character(nydia_sf$CLUSTER_ID), cex=0.5, col="black")
#plot((nydia_sf %>% st_geometry()), main="Nydia Polygon Volumes to 15m")
#plot((nydia_sf %>% select(volume_15)), add=TRUE)
plot((nydia_sf %>% select(volume_15)), main="Nydia Polygon Volumes to 15m")
```

Communication matrix

```{r}
pmat <- t(connsub[[1]])
dimnames(pmat) <- list(nydia_sf$CLUSTER_ID,nydia_sf$CLUSTER_ID)
#dim(pmat) # 17 17
n <- nrow(pmat) # 17 polygons
# residency
resvec <- diag(pmat)
# retention
retvec <- apply(pmat,1,sum)
rrdf <- data.frame(CLUSTER_ID=names(resvec), residency=resvec, retention=retvec)
nydia_sf <- merge(nydia_sf,rrdf)
```

```{r warning=FALSE}
#par(mfrow=c(1,2))
plot((nydia_sf %>% select(retention)), main="Nydia Polygon 1 Week Retention")
plot((nydia_sf %>% select(residency)), main="Nydia Polygon Residency")
```


```{r}
image(1:n, 1:n, pmat, axes=FALSE, xlab="Destination", ylab="Source", 
      main="Communication between polygons",asp=1)
axis(1,at=1:n,lab=nydia_sf$CLUSTER_ID,las=2,cex.axis=0.7)
axis(2,at=1:n,lab=nydia_sf$CLUSTER_ID,las=2,cex.axis=0.7)
box()
```



```{r}
nt <- 5*52 + 18 # number of weeks to simulate
w1 <- 2505; w2 <- w1 + nt-1
#week.as.date(2505) # 2018-01-01
tvec <- w1:w2
qvec <- seasonfunc(tvec) # TRUE if month is Dec-Jul, FALSE if month is Aug-Nov
```

```{r}
plot(week.as.date(tvec), qvec, type="s", xlab="", ylab="Season", axes=FALSE)
title("Summer Seasons")
#axis.Date(1,format="%b %Y", las=2); axis(2); box()
axis.Date(1,format="%Y", las=1); axis(2); box()
```

Epochs

```{r}
set.seed(-4)
tau0 <- 0.30 # initiation probability
tau1 <- 0.90 # persistence probability
evec <- rep(0,length(tvec))
evec[1] <- rbinom(1,1,tau0*qvec[1])
for(i in 2:nt) {
  evec[i] <- if(evec[i-1]==0) rbinom(1,1,tau0*qvec[i]) else rbinom(1,1,tau1*qvec[i])
}
```



```{r}
plot(week.as.date(tvec), qvec, type="s", col="grey", 
     xlab="Date", ylab="Bloom favourability", 
     main="Bloom epochs", axes=FALSE)
bb <- block01(tvec,qvec)
polygon(week.as.date(bb[,1]), bb[,2], col="grey")
lines(week.as.date(tvec), evec, type="s")
bb <- block01(tvec,evec)
polygon(week.as.date(bb[,1]),bb[,2], col="orange")
#polygon(week.as.date(c(tvec[1],tvec,tvec[length(tvec)])), c(0,evec,0), col="orange")
axis.Date(1); axis(2,at=c(0,1)); box()
```
```{r}
# Polygon carrying capacity
volvec <- nydia_sf$volume_15
alphac <- 5
lambdac <- 1.5
rhocvec <- exp(alphac + lambdac*log(resvec))
mcvec <- volvec*rhocvec
plot(resvec, rhocvec, xlab="Residency", ylab=expression("Polygon carrying density: "*rho[cit]),
     main="Polygon carrying density", pch=" "); text(resvec, rhocvec, lab=names(resvec), cex=0.6)
```

```{r warning=FALSE}
plot((nydia_sf %>% mutate(rhoc=rhocvec[nid]))['rhoc'], main="Carrying density",reset=FALSE)
text(nydia_sf %>% st_centroid(of_largest_polygon=TRUE) %>% st_coordinates(),
     lab=as.character(nydia_sf$CLUSTER_ID), cex=0.8, col="white")
```

```{r}
plot(resvec, mcvec, xlab="Residency", ylab=expression("Polygon carrying capacity: "*M[cit]),
     main="Polygon carrying capacity", pch=" "); text(resvec, mcvec, lab=names(resvec), cex=0.6)
```

```{r}
# Bloom initiation probability
volvec <- nydia_sf$volume_15
areavec <- as.numeric(nydia_sf$area)
#alpha0 <- -6.0; lambda0 <- 3.03
# alpha0 <- -5.8; lambda0 <- 3.1
alpha0 <- -4.8; lambda0 <- 1.6
pavec <- areavec*exp(alpha0 + lambda0*log(resvec))
rbind(alpha0 + lambda0*log(resvec),
      exp(alpha0 + lambda0*log(resvec)),
      pavec)[,c(2,5,13)]
#plot(resvec, logit(pavec))
plot(resvec, pavec, xlab="Residency", ylab=expression("Bloom initiation probability: "*pi[it]),
     main="Bloom initiation probability", pch=" "); text(resvec, pavec, lab=names(resvec), cex=0.6)
```

```{r warning=FALSE}
plot((nydia_sf %>% mutate(pa=pavec[nid]))['pa'], main="Weekly initiation probability",reset=FALSE)
text(nydia_sf %>% st_centroid(of_largest_polygon=TRUE) %>% st_coordinates(),
     lab=as.character(nydia_sf$CLUSTER_ID), cex=0.8, col="white")
```

```{r}
pimat <- outer(qvec*evec,pavec)
colnames(pimat) <- names(pavec)
# Innovation indicator
set.seed(-5)
imat <- array(rbinom(length(pimat),1,pimat),dim=dim(pimat))
apply(imat,2,sum)
colnames(imat) <- names(pavec)
breaks <- -0.5+0:(1+max(apply(imat,2,sum)))
plot((nydia_sf %>% mutate(nstart=apply(imat,2,sum)[nid]))['nstart'], 
     main="Number of initiations", reset=FALSE, breaks=breaks)
text(nydia_sf %>% st_centroid(of_largest_polygon=TRUE) %>% st_coordinates(), 
     lab=as.character(nydia_sf$CLUSTER_ID), cex=0.5, col="white")
```

Time of initiations

```{r}
image(week.as.date(tvec), 1:n, imat, axes=FALSE, xlab="Week", ylab="Polygon")
title("Bloom initiation")
axis.Date(1); axis(2,at=1:n,lab=names(pavec), las=2); box()
abline(v=as.Date(paste(2018:2023,"01-01",sep="-")), lty=2)
```

Biomass innovation

```{r}
set.seed(-9)
btmean <- 0.01; btvar <- (0.5*btmean)^2
abio <- btmean^2/btvar; bbio <- btmean/btvar
btmat <- array(rgamma(prod(dim(pimat)),abio,bbio),dim=dim(pimat))
btmat <- imat*btmat
```

```{r}
image(week.as.date(tvec), 1:n, btmat, axes=FALSE, xlab="Week", ylab="Polygon")
title("Innovation biomass")
axis.Date(1,format="%Y"); axis(2,at=1:n,names(pavec),las=2); box()
abline(v=as.Date(paste(2018:2023,"01-01",sep="-")), lty=2)
```

```{r}
#knitr::knit_exit()
```


Mass evolution

```{r}
lambda1 <- 0.0
gamma2 <- 1.5
alpha2 <- 1.0
lambda2 <- 1.0
sigma.eta <- 0.03
sigma.logy <- 0.03

qmat <- array(NA,dim=dim(pimat))
dmat <- array(NA,dim=dim(pimat))
mmat <- array(0,dim=dim(pimat))
cmat <- mmat
mmat[1,] <- btmat[1,]
cmat[1,] <- mmat[1,]/volvec
qmat[1,] <- 1
dmat[1,] <- 0

set.seed(-3)
etamat <- array(rnorm(prod(dim(pimat)),0,sigma.eta),dim=dim(pimat))
for(t in 2:nt) {
  qvec <- exp(-gamma2*(1-evec[t]) + evec[t]*(alpha2+lambda2*log(resvec)))
  gvec <- exp(evec[t]*lambda1*log(resvec))
  dvec <- btmat[t,] + pmat%*%diag(gvec)%*%mmat[t-1,]
  mvec <- mcvec*(1-exp(-qvec*dvec/mcvec))
  mmat[t,] <- exp(etamat[t,])*mvec
  cmat[t,] <- mmat[t,]/volvec
  dmat[t,] <- dvec
  qmat[t,] <- qvec
}
ymat <- array(exp(rnorm(prod(dim(cmat)),0,sigma.logy)),dim=dim(pimat))
```

```{r}
par(mfrow=c(1,2))
plot(tvec,(mmat[,2]))
abline(v=tvec[evec==1],col="lightgrey")
points(tvec,mmat[,2])
plot(tvec,log(mmat[,2]))
abline(v=tvec[evec==1],col="lightgrey")
points(tvec,log(mmat[,2]))
```

```{r}
ipoly <- which(names(pavec)=="200")
par(mfrow=c(1,2))
plot(tvec,(mmat[,ipoly]))
abline(v=tvec[evec==1],col="lightgrey")
points(tvec,mmat[,ipoly])
plot(tvec,log(mmat[,ipoly]))
abline(v=tvec[evec==1],col="lightgrey")
points(tvec,log(mmat[,ipoly]))
```




```{r}
image(week.as.date(tvec), 1:n, mmat, axes=FALSE, xlab="Week", ylab="Polygon")
title("Algal biomass")
axis.Date(1,format="%Y"); axis(2,at=1:n,names(pavec),las=2); box()
abline(v=as.Date(paste(2018:2023,"01-01",sep="-")), lty=2)
```

```{r}
image(week.as.date(tvec), 1:n, cmat, axes=FALSE, xlab="Week", ylab="Polygon")
title("Algal concentration")
axis.Date(1,format="%Y"); axis(2,at=1:n,names(pavec),las=2); box()
abline(v=as.Date(paste(2018:2023,"01-01",sep="-")), lty=2)
```

```{r}
image(week.as.date(tvec), 1:n, cmat, axes=FALSE, xlab="Week", ylab="Polygon")
title("Observed algal concentration")
axis.Date(1,format="%Y"); axis(2,at=1:n,names(pavec),las=2); box()
abline(v=as.Date(paste(2018:2023,"01-01",sep="-")), lty=2)
```


```{r}
xrange <- c(0,max(cmat))
nbreaks <- 11
breaks <- seq(from=xrange[1], to=xrange[2], length=nbreaks)
colvec <- colorRampPalette(c("light grey","red"))(nbreaks-1)
t <- 1
t <- 53
week <- tvec[t]
plot((nydia_sf %>% mutate(concentration=cmat[t,]))['concentration'], 
     pal=colvec,breaks=breaks,
     main=paste0("Algal concentration in Week ",week),reset=FALSE)
```

```{r}
plot(tvec,apply(cmat,1,max), xlab="Week", ylab="Maxmimum observed concentration",
     main="Maximum concentration")
lines(tvec, apply(cmat,1,max))
```

```{r}
ii <- find.events(cmat)

xx <- apply(cmat,1,max)
plot(tvec,xx); lines(tvec,xx)
abline(v=tvec[ii$istart],col="green"); abline(v=tvec[ii$iend],col="blue")
nrow(ii) # 8 events
ii$xmax
```

```{r}
t <- 1
#for(t in 1:nt) {
im <- which.max(ii$xmax)
#for(t in 100:130) {
for(t in (max(1,ii$istart[im]-2)):(min(nt,ii$iend[im]+2))) {
  week <- tvec[t]
  plot((nydia_sf %>% mutate(concentration=cmat[t,]))['concentration'], 
     pal=colvec,breaks=breaks,
     main=paste0("Algal concentration in Week ",week),reset=FALSE)
}
```



### Full area

```{r warning=FALSE}
#par(mfrow=c(1,2))
all_sf <- marlpoly_sf.trim
all_sf <- all_sf[all_sf$volume_15>0,]
plot((all_sf %>% st_geometry()), main="Marlborough")
text(all_sf %>% st_centroid(of_largest_polygon=TRUE) %>% st_coordinates(), 
     lab=as.character(all_sf$CLUSTER_ID), cex=0.5, col="black")
#plot((all_sf %>% st_geometry()), main="Nydia Polygon Volumes to 15m")
#plot((all_sf %>% select(volume_15)), add=TRUE)
plot((all_sf %>% select(volume_15)), main="Polygon Volumes to 15m")
```

Communication matrix

```{r}
pmat <- t(conn[[1]])
colnames(pmat) <- marlpoly_sf.trim$CLUSTER_ID
rownames(pmat) <- colnames(pmat)
n <- nrow(pmat) # 408 polygons
idx <- colnames(pmat) %in% all_sf$CLUSTER_ID
pmat <- pmat[idx,][,idx]
dim(pmat)
n <- nrow(pmat) # 407 polygons (eliminating the zero volume polygon)
# residency
resvec <- diag(pmat)
names(resvec) <- colnames(pmat)
# retention
retvec <- apply(pmat,1,sum)
rrdf <- data.frame(CLUSTER_ID=as.numeric(names(resvec)), residency=resvec, retention=retvec)
all_sf$resvec <- NULL; all_sf$retention <- NULL
all_sf <- merge(all_sf,rrdf)
all_sf$nid <- 1:n
```

```{r warning=FALSE}
#par(mfrow=c(1,2))
plot((all_sf %>% select(retention)), main="Polygon 1 Week Retention")
plot((all_sf %>% select(residency)), main="Polygon Residency")
```


```{r}
image(1:n, 1:n, pmat, axes=FALSE, xlab="Destination", ylab="Source", 
      main="Communication between polygons",asp=1)
axis(1,at=1:n,lab=all_sf$CLUSTER_ID,las=2,cex.axis=0.7)
axis(2,at=1:n,lab=all_sf$CLUSTER_ID,las=2,cex.axis=0.7)
box()
```

```{r}
nt <- 5*52 + 18 # number of weeks to simulate
w1 <- 2505; w2 <- w1 + nt-1
#week.as.date(2505) # 2018-01-01
tvec <- w1:w2
qvec <- seasonfunc(tvec) # TRUE if month is Dec-Jul, FALSE if month is Aug-Nov
```

```{r}
plot(week.as.date(tvec), qvec, type="s", xlab="", ylab="Season", axes=FALSE)
title("Summer Seasons")
#axis.Date(1,format="%b %Y", las=2); axis(2); box()
axis.Date(1,format="%Y", las=1); axis(2); box()
```

Epochs

```{r}
set.seed(-4)
tau0 <- 0.30 # initiation probability
tau1 <- 0.90 # persistence probability
evec <- rep(0,length(tvec))
evec[1] <- rbinom(1,1,tau0*qvec[1])
for(i in 2:nt) {
  evec[i] <- if(evec[i-1]==0) rbinom(1,1,tau0*qvec[i]) else rbinom(1,1,tau1*qvec[i])
}
```


```{r}
plot(week.as.date(tvec), qvec, type="s", col="grey", 
     xlab="Date", ylab="Bloom favourability", 
     main="Bloom epochs", axes=FALSE)
bb <- block01(tvec,qvec)
polygon(week.as.date(bb[,1]), bb[,2], col="grey")
lines(week.as.date(tvec), evec, type="s")
bb <- block01(tvec,evec)
polygon(week.as.date(bb[,1]),bb[,2], col="orange")
#polygon(week.as.date(c(tvec[1],tvec,tvec[length(tvec)])), c(0,evec,0), col="orange")
axis.Date(1); axis(2,at=c(0,1)); box()
```
```{r}
# Polygon carrying capacity
volvec <- all_sf$volume_15
alphac <- 5
lambdac <- 1.5
rhocvec <- exp(alphac + lambdac*log(resvec))
mcvec <- volvec*rhocvec
plot(resvec, rhocvec, xlab="Residency", ylab=expression("Polygon carrying density: "*rho[cit]),
     main="Polygon carrying density", pch=" "); text(resvec, rhocvec, lab=names(resvec), cex=0.6)
```

```{r warning=FALSE}
plot((all_sf %>% mutate(rhoc=rhocvec[nid]))['rhoc'], main="Carrying density",reset=FALSE)
text(all_sf %>% st_centroid(of_largest_polygon=TRUE) %>% st_coordinates(),
     lab=as.character(all_sf$CLUSTER_ID), cex=0.2, col="white")
```

```{r}
plot(resvec, mcvec, xlab="Residency", ylab=expression("Polygon carrying capacity: "*M[cit]),
     main="Polygon carrying capacity", pch=" "); text(resvec, mcvec, lab=names(resvec), cex=0.6)
```

```{r}
# Bloom initiation probability
volvec <- all_sf$volume_15
areavec <- as.numeric(all_sf$area)
#alpha0 <- -6.0; lambda0 <- 3.03
# alpha0 <- -5.8; lambda0 <- 3.1
alpha0 <- -4.8; lambda0 <- 1.6
pavec <- areavec*exp(alpha0 + lambda0*log(resvec))
rbind(alpha0 + lambda0*log(resvec),
      exp(alpha0 + lambda0*log(resvec)),
      pavec)[,c(2,5,13)]
#plot(resvec, logit(pavec))
plot(resvec, pavec, xlab="Residency", ylab=expression("Bloom initiation probability: "*pi[it]),
     main="Bloom initiation probability", pch=" "); text(resvec, pavec, lab=names(resvec), cex=0.6)
```

```{r warning=FALSE}
plot((all_sf %>% mutate(pa=pavec[nid]))['pa'], main="Weekly initiation probability",reset=FALSE)
text(all_sf %>% st_centroid(of_largest_polygon=TRUE) %>% st_coordinates(),
     lab=as.character(all_sf$CLUSTER_ID), cex=0.2, col="white")
```

```{r}
pimat <- outer(qvec*evec,pavec)
colnames(pimat) <- names(pavec)
# Innovation indicator
set.seed(-7)
imat <- array(rbinom(length(pimat),1,pimat),dim=dim(pimat))
apply(imat,2,sum)
colnames(imat) <- names(pavec)
breaks <- -0.5+0:(1+max(apply(imat,2,sum)))
plot((all_sf %>% mutate(nstart=apply(imat,2,sum)[nid]))['nstart'], 
     main="Number of initiations", reset=FALSE, breaks=breaks)
text(all_sf %>% st_centroid(of_largest_polygon=TRUE) %>% st_coordinates(), 
     lab=as.character(all_sf$CLUSTER_ID), cex=0.2, col="white")
```

Time of initiations

```{r}
image(week.as.date(tvec), 1:n, imat, axes=FALSE, xlab="Week", ylab="Polygon")
title("Bloom initiation")
axis.Date(1); axis(2,at=1:n,lab=names(pavec), las=2); box()
abline(v=as.Date(paste(2018:2023,"01-01",sep="-")), lty=2)
```

Biomass innovation

```{r}
set.seed(-9)
btmean <- 0.01; btvar <- (0.5*btmean)^2
abio <- btmean^2/btvar; bbio <- btmean/btvar
btmat <- array(rgamma(prod(dim(pimat)),abio,bbio),dim=dim(pimat))
btmat <- imat*btmat
```

```{r}
image(week.as.date(tvec), 1:n, btmat, axes=FALSE, xlab="Week", ylab="Polygon")
title("Innovation biomass")
axis.Date(1,format="%Y"); axis(2,at=1:n,names(pavec),las=2); box()
abline(v=as.Date(paste(2018:2023,"01-01",sep="-")), lty=2)
```

```{r}
knitr::knit_exit()
```


Mass evolution

```{r}
lambda1 <- 0.0
gamma2 <- 1.5
alpha2 <- 1.0
lambda2 <- 1.0
sigma.eta <- 0.03
sigma.logy <- 0.03

qmat <- array(NA,dim=dim(pimat))
dmat <- array(NA,dim=dim(pimat))
mmat <- array(0,dim=dim(pimat))
cmat <- mmat
mmat[1,] <- btmat[1,]
cmat[1,] <- mmat[1,]/volvec
qmat[1,] <- 1
dmat[1,] <- 0

set.seed(-3)
etamat <- array(rnorm(prod(dim(pimat)),0,sigma.eta),dim=dim(pimat))
for(t in 2:nt) {
  qvec <- exp(-gamma2*(1-evec[t]) + evec[t]*(alpha2+lambda2*log(resvec)))
  gvec <- exp(evec[t]*lambda1*log(resvec))
  dvec <- btmat[t,] + pmat%*%diag(gvec)%*%mmat[t-1,]
  mvec <- mcvec*(1-exp(-qvec*dvec/mcvec))
  mmat[t,] <- exp(etamat[t,])*mvec
  cmat[t,] <- mmat[t,]/volvec
  dmat[t,] <- dvec
  qmat[t,] <- qvec
}
ymat <- array(exp(rnorm(prod(dim(cmat)),0,sigma.logy)),dim=dim(pimat))
```

```{r}
par(mfrow=c(1,2))
plot(tvec,(mmat[,2]))
abline(v=tvec[evec==1],col="lightgrey")
points(tvec,mmat[,2])
plot(tvec,log(mmat[,2]))
abline(v=tvec[evec==1],col="lightgrey")
points(tvec,log(mmat[,2]))
```

```{r}
ipoly <- which(names(pavec)=="200")
par(mfrow=c(1,2))
plot(tvec,(mmat[,ipoly]))
abline(v=tvec[evec==1],col="lightgrey")
points(tvec,mmat[,ipoly])
plot(tvec,log(mmat[,ipoly]))
abline(v=tvec[evec==1],col="lightgrey")
points(tvec,log(mmat[,ipoly]))
```




```{r}
image(week.as.date(tvec), 1:n, mmat, axes=FALSE, xlab="Week", ylab="Polygon")
title("Algal biomass")
axis.Date(1,format="%Y"); axis(2,at=1:n,names(pavec),las=2); box()
abline(v=as.Date(paste(2018:2023,"01-01",sep="-")), lty=2)
```

```{r}
image(week.as.date(tvec), 1:n, cmat, axes=FALSE, xlab="Week", ylab="Polygon")
title("Algal concentration")
axis.Date(1,format="%Y"); axis(2,at=1:n,names(pavec),las=2); box()
abline(v=as.Date(paste(2018:2023,"01-01",sep="-")), lty=2)
```

```{r}
image(week.as.date(tvec), 1:n, cmat, axes=FALSE, xlab="Week", ylab="Polygon")
title("Observed algal concentration")
axis.Date(1,format="%Y"); axis(2,at=1:n,names(pavec),las=2); box()
abline(v=as.Date(paste(2018:2023,"01-01",sep="-")), lty=2)
```


```{r}
xrange <- c(0,max(cmat))
nbreaks <- 11
breaks <- seq(from=xrange[1], to=xrange[2], length=nbreaks)
colvec <- colorRampPalette(c("light grey","red"))(nbreaks-1)
t <- 1
t <- 53
week <- tvec[t]
plot((all_sf %>% mutate(concentration=cmat[t,]))['concentration'], 
     pal=colvec,breaks=breaks,
     main=paste0("Algal concentration in Week ",week),reset=FALSE)
```

```{r}
plot(tvec,apply(cmat,1,max), xlab="Week", ylab="Maxmimum observed concentration",
     main="Maximum concentration")
lines(tvec, apply(cmat,1,max))
```

```{r}
ii <- find.events(cmat)

xx <- apply(cmat,1,max)
plot(tvec,xx); lines(tvec,xx)
abline(v=tvec[ii$istart],col="green"); abline(v=tvec[ii$iend],col="blue")
nrow(ii) # 8 events
ii$xmax
```

```{r}
t <- 1
#for(t in 1:nt) {
im <- which.max(ii$xmax)
#for(t in 100:130) {
for(t in (max(1,ii$istart[im]-2)):(min(nt,ii$iend[im]+2))) {
  week <- tvec[t]
  plot((all_sf %>% mutate(concentration=cmat[t,]))['concentration'], 
     pal=colvec,breaks=breaks,
     main=paste0("Algal concentration in Week ",week),reset=FALSE)
}
```








